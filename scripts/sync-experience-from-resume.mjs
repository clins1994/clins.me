import fs from 'node:fs/promises'
import path from 'node:path'

const rootDir = process.cwd()
const resumePath = path.join(rootDir, 'src/content/resume.md')
const experiencePath = path.join(rootDir, 'src/data/experience.ts')

function stripLeadingSymbols(value) {
  return value.replace(/^[^A-Za-z0-9]+/, '').trim()
}

function escapeString(value) {
  return value.replace(/\\/g, '\\\\').replace(/'/g, "\\'")
}

function quote(value) {
  return `'${escapeString(value)}'`
}

function splitMeta(metaLine) {
  const separators = ['â–ª', 'Â·', '|']
  for (const separator of separators) {
    if (metaLine.includes(separator)) {
      const [left, right] = metaLine.split(separator).map((part) => part.trim())
      if (left && right) return { location: left, dates: right }
    }
  }
  throw new Error(`Unable to parse location/date line: "${metaLine}"`)
}

function splitDates(dateLine) {
  const [startRaw, endRaw] = dateLine.split(/\s*[~-]\s*/)
  const start = startRaw?.trim()
  const end = endRaw?.trim()

  if (!start) throw new Error(`Unable to parse start date from: "${dateLine}"`)

  if (!end || /^present$/i.test(end)) {
    return { start, end: undefined }
  }

  return { start, end }
}

function parseEmployment(resumeMarkdown) {
  const employmentStart = resumeMarkdown.indexOf('\n## Employment')
  if (employmentStart === -1) throw new Error('Could not find "## Employment" section in resume.md')

  const nextSectionStart = resumeMarkdown.indexOf('\n## ', employmentStart + 1)
  const employmentSection =
    nextSectionStart === -1
      ? resumeMarkdown.slice(employmentStart)
      : resumeMarkdown.slice(employmentStart, nextSectionStart)

  const blocks = employmentSection
    .split('\n### ')
    .slice(1)
    .map((block) => `### ${block}`.trim())

  if (!blocks.length) throw new Error('No employment entries found under "## Employment"')

  return blocks.map((block) => {
    const lines = block
      .split('\n')
      .map((line) => line.trim())
      .filter(Boolean)

    const heading = lines[0]
    const headingText = heading.replace(/^###\s+/, '').trim()
    const companyMatch = headingText.match(/\[(.+?)\]\((.+?)\)/)
    if (!companyMatch)
      throw new Error(`Could not parse company link from heading: "${headingText}"`)

    const company = companyMatch[1].trim()
    const href = companyMatch[2].trim()

    const rolePart = headingText
      .slice(0, companyMatch.index)
      .replace(/[â–ªÂ·|:-]\s*$/, '')
      .trim()
    const role = stripLeadingSymbols(rolePart)

    const metaLine = lines[1]
    if (!metaLine) throw new Error(`Missing location/date line for role: "${role}"`)
    const { location: rawLocation, dates } = splitMeta(metaLine)
    const location = stripLeadingSymbols(rawLocation)
    const { start, end } = splitDates(dates)

    const highlights = lines
      .filter((line) => line.startsWith('- '))
      .map((line) => line.replace(/^- /, '').trim())

    const toolsLine = lines.find((line) => line.startsWith('ðŸ› ï¸') || /^Tools:/i.test(line))
    if (!toolsLine) throw new Error(`Missing tools line for role: "${role}"`)

    const tags = toolsLine
      .replace(/^ðŸ› ï¸\s*/, '')
      .replace(/^Tools:\s*/i, '')
      .split(',')
      .map((tag) => tag.trim())
      .filter(Boolean)

    return {
      role,
      company: { name: company, href },
      location,
      start,
      end,
      highlights,
      tags
    }
  })
}

function renderExperienceFile(experienceEntries) {
  const lines = []

  lines.push('// AUTO-GENERATED by scripts/sync-experience-from-resume.mjs')
  lines.push('// Source of truth: src/content/resume.md (## Employment)')
  lines.push('')
  lines.push('export type Experience = {')
  lines.push('  role: string')
  lines.push('  company: {')
  lines.push('    name: string')
  lines.push('    href?: string')
  lines.push('  }')
  lines.push('  location: string')
  lines.push('  start: string')
  lines.push('  end?: string')
  lines.push('  highlights: string[]')
  lines.push('  tags: string[]')
  lines.push('}')
  lines.push('')
  lines.push('export const EXPERIENCE: Experience[] = [')

  experienceEntries.forEach((entry) => {
    lines.push('  {')
    lines.push(`    role: ${quote(entry.role)},`)
    lines.push(
      `    company: { name: ${quote(entry.company.name)}, href: ${quote(entry.company.href)} },`
    )
    lines.push(`    location: ${quote(entry.location)},`)
    lines.push(`    start: ${quote(entry.start)},`)
    if (entry.end) {
      lines.push(`    end: ${quote(entry.end)},`)
    }
    lines.push('    highlights: [')
    entry.highlights.forEach((highlight) => {
      lines.push(`      ${quote(highlight)},`)
    })
    lines.push('    ],')
    lines.push('    tags: [')
    entry.tags.forEach((tag) => {
      lines.push(`      ${quote(tag)},`)
    })
    lines.push('    ]')
    lines.push('  },')
  })

  lines.push(']')
  lines.push('')

  return lines.join('\n')
}

async function main() {
  const resumeMarkdown = await fs.readFile(resumePath, 'utf8')
  const experienceEntries = parseEmployment(resumeMarkdown)
  const output = renderExperienceFile(experienceEntries)
  await fs.writeFile(experiencePath, output, 'utf8')
}

await main()
